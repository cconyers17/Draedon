# Text-to-CAD Application Deployment Guide

Complete deployment guide for the Text-to-CAD web application on Render.com with production-ready configurations, monitoring, and scaling.

## Table of Contents

1. [Overview](#overview)
2. [Architecture](#architecture)
3. [Prerequisites](#prerequisites)
4. [Environment Setup](#environment-setup)
5. [Database Configuration](#database-configuration)
6. [Deployment Process](#deployment-process)
7. [Monitoring and Health Checks](#monitoring-and-health-checks)
8. [Scaling and Performance](#scaling-and-performance)
9. [Security Configuration](#security-configuration)
10. [Troubleshooting](#troubleshooting)
11. [Maintenance](#maintenance)

## Overview

The Text-to-CAD application is deployed as a multi-service architecture on Render.com with the following components:

- **Frontend**: Next.js 14 application with TypeScript and Three.js
- **Backend**: FastAPI application with Python 3.11
- **Database**: PostgreSQL 15 with spatial extensions
- **Cache**: Redis for session and API caching
- **CDN**: Static asset delivery via Render's CDN

## Architecture

### Service Architecture
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │    Backend      │    │   Database      │
│   (Next.js)     │◄──►│   (FastAPI)     │◄──►│  (PostgreSQL)   │
│   Port: 3000    │    │   Port: 10000   │    │   Port: 5432    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Static CDN    │    │     Redis       │    │   File Storage  │
│   (Assets)      │    │    (Cache)      │    │   (Uploads)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Data Flow
1. User requests → Frontend (Next.js)
2. API calls → Backend (FastAPI)
3. Data storage → PostgreSQL
4. Session/Cache → Redis
5. Static assets → CDN
6. File uploads → Persistent storage

## Prerequisites

### Required Tools
- Git (for version control)
- Node.js 20+ (for frontend development)
- Python 3.11+ (for backend development)
- Docker (for containerization)
- Render.com account (for hosting)

### Required API Keys
- Render.com API key (for deployments)
- Meshy AI API key (for 3D generation)
- Trellis 3D API key (for 3D processing)
- Rodin AI API key (for AI-driven CAD)

## Environment Setup

### 1. Clone Repository
```bash
git clone https://github.com/your-org/text-to-cad.git
cd text-to-cad
```

### 2. Environment Variables

#### Development (.env.local)
```bash
cp .env.example .env.local
# Edit .env.local with your development values
```

#### Production Environment
Set the following environment variables in Render.com dashboard:

**Database & Cache:**
```
DATABASE_URL=postgresql://textcad_user:${POSTGRES_PASSWORD}@text-to-cad-postgres:5432/textcad_production
REDIS_URL=redis://text-to-cad-redis:6379/0
```

**Security:**
```
SECRET_KEY=${SECRET_KEY}  # Auto-generated by Render
CORS_ORIGINS=https://text-to-cad-frontend.onrender.com
```

**External APIs:**
```
MESHY_AI_API_KEY=your_meshy_api_key
TRELLIS_3D_API_KEY=your_trellis_api_key
RODIN_AI_API_KEY=your_rodin_api_key
```

**Performance:**
```
MAX_WORKERS=4
WORKER_TIMEOUT=300
WEB_CONCURRENCY=4
```

## Database Configuration

### PostgreSQL Setup

The database is automatically configured with:
- PostGIS for spatial data
- Full-text search extensions
- Performance optimizations
- Custom functions for CAD operations

### Migrations
```bash
# Run migrations (automated in deployment)
alembic upgrade head

# Initialize database
python scripts/init_db.py
```

### Redis Setup
Redis is configured for:
- Session storage
- API response caching
- Rate limiting
- Real-time notifications

## Deployment Process

### Automatic Deployment (Recommended)

1. **Push to GitHub:**
```bash
git push origin main        # Deploy to staging
git push origin production  # Deploy to production
```

2. **GitHub Actions will:**
- Run tests (frontend & backend)
- Security scanning
- Build Docker images
- Deploy to Render.com
- Run health checks
- Performance testing

### Manual Deployment

1. **Using Deployment Script:**
```bash
# Deploy to staging
./scripts/deploy.sh staging --health-check

# Deploy to production (requires confirmation)
./scripts/deploy.sh production --health-check
```

2. **Direct Render.com Dashboard:**
- Go to Render.com dashboard
- Select your services
- Click "Deploy Latest Commit"

### Deployment Checklist

Before deploying to production:

- [ ] All tests pass
- [ ] Environment variables configured
- [ ] Database migrations ready
- [ ] API keys validated
- [ ] Performance tests complete
- [ ] Security scans clean
- [ ] Health checks configured
- [ ] Monitoring alerts set up
- [ ] Backup strategy in place

## Monitoring and Health Checks

### Health Check Endpoints

**Backend Health Check:**
```bash
curl https://text-to-cad-backend.onrender.com/health
```

Response:
```json
{
  "status": "ok",
  "timestamp": "2025-01-15T10:00:00Z",
  "system": {
    "cpu_usage_percent": 45.2,
    "memory_usage_percent": 67.8
  },
  "database": {"status": "connected"},
  "redis": {"status": "connected"}
}
```

**Frontend Health Check:**
```bash
curl https://text-to-cad-frontend.onrender.com/api/health
```

### Monitoring Metrics

**Key Performance Indicators:**
- Response time (p95 < 2s)
- Error rate (< 1%)
- Availability (> 99.9%)
- Database connection pool usage
- Memory usage
- CPU utilization

**Business Metrics:**
- CAD generation success rate
- File upload success rate
- API request volume
- User session duration

### Alerts Configuration

Set up alerts for:
- High error rates (>5%)
- Slow response times (p95 >5s)
- Database connection failures
- High memory usage (>90%)
- Failed deployments

## Scaling and Performance

### Auto-Scaling Configuration

**Frontend Scaling:**
```yaml
scaling:
  minInstances: 1
  maxInstances: 8
  targetMemoryPercent: 80
  targetCPUPercent: 80
```

**Backend Scaling:**
```yaml
scaling:
  minInstances: 1
  maxInstances: 10
  targetMemoryPercent: 70
  targetCPUPercent: 70
```

### Performance Optimizations

**Frontend:**
- Static asset CDN
- Image optimization
- Code splitting
- Bundle analysis
- Service worker caching

**Backend:**
- Database connection pooling
- Redis caching
- Async request handling
- Rate limiting
- Response compression

**Database:**
- Indexed queries
- Query optimization
- Connection pooling
- Read replicas (if needed)

### Load Testing

Run performance tests:
```bash
# Install k6
npm install -g k6

# Run performance tests
k6 run scripts/performance-test.js
```

Expected performance targets:
- Frontend: 1000+ requests/minute
- Backend API: 500+ requests/minute
- CAD generation: 10-20 concurrent jobs
- File uploads: 50MB files in <30s

## Security Configuration

### Network Security
- HTTPS only (enforced by Render)
- CORS properly configured
- Rate limiting enabled
- DDoS protection via Render

### Application Security
- Input validation
- SQL injection prevention
- XSS protection
- CSRF protection
- File upload validation

### Data Security
- Database encryption at rest
- Secure environment variables
- API key rotation
- Audit logging

### Security Headers
```
X-Frame-Options: DENY
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Referrer-Policy: strict-origin-when-cross-origin
Content-Security-Policy: default-src 'self'...
```

## Troubleshooting

### Common Issues

**Deployment Failures:**
1. Check build logs in Render dashboard
2. Verify environment variables
3. Test Docker build locally
4. Check dependency versions

**Database Connection Issues:**
```bash
# Test database connection
python -c "
import asyncio
from app.database import test_connection
asyncio.run(test_connection())
"
```

**High Memory Usage:**
- Monitor memory usage in health checks
- Adjust worker count
- Check for memory leaks
- Optimize database queries

**Slow Performance:**
- Check database query performance
- Monitor Redis cache hit ratio
- Analyze slow request logs
- Run performance tests

### Debug Commands

**Check service status:**
```bash
curl https://text-to-cad-backend.onrender.com/health
```

**View logs:**
- Use Render.com dashboard
- Or stream logs via Render CLI

**Database debugging:**
```sql
-- Check active connections
SELECT * FROM pg_stat_activity;

-- Check slow queries
SELECT * FROM pg_stat_statements ORDER BY total_time DESC LIMIT 10;
```

### Recovery Procedures

**Database Recovery:**
1. Check database health
2. Restart database service
3. Run integrity checks
4. Restore from backup if needed

**Application Recovery:**
1. Check health endpoints
2. Restart services
3. Clear Redis cache
4. Rollback deployment if needed

## Maintenance

### Regular Tasks

**Daily:**
- Monitor health dashboards
- Check error rates
- Review performance metrics

**Weekly:**
- Database maintenance
- Security updates
- Performance optimization
- Log cleanup

**Monthly:**
- Backup verification
- Security audit
- Capacity planning
- Cost optimization

### Backup Strategy

**Database Backups:**
- Automated daily backups via Render
- Point-in-time recovery available
- Cross-region backup storage

**Application Backups:**
- Git version control
- Docker image tags
- Configuration snapshots

### Update Process

**Security Updates:**
1. Test in staging environment
2. Schedule maintenance window
3. Deploy with rollback plan
4. Monitor post-deployment

**Feature Updates:**
1. Feature flags for gradual rollout
2. A/B testing capabilities
3. Canary deployment strategy
4. User feedback collection

### Support Contacts

**Development Team:**
- Email: dev-team@your-company.com
- Slack: #text-to-cad-support

**Infrastructure:**
- Render.com support
- Database administrator
- DevOps team

## Cost Optimization

### Resource Management
- Right-size service plans
- Use auto-scaling effectively
- Monitor resource usage
- Optimize database queries

### Cost Monitoring
- Track monthly spending
- Set up billing alerts
- Analyze cost per user
- Optimize external API usage

## Conclusion

This deployment guide provides a comprehensive setup for the Text-to-CAD application on Render.com. The configuration supports:

- **High Availability**: Multi-service architecture with health checks
- **Scalability**: Auto-scaling based on demand
- **Security**: Industry-standard security practices
- **Performance**: Optimized for production workloads
- **Monitoring**: Comprehensive observability
- **Maintenance**: Automated deployment and maintenance procedures

For additional support or questions, refer to the troubleshooting section or contact the development team.

---

**Last Updated:** January 2025
**Version:** 1.0.0
**Maintained By:** Text-to-CAD Development Team